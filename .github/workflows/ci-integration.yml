name: CI Integration Tests

on:
    push:
        branches: [main]

jobs:
    integration-tests:
        name: Integration Tests (MySQL)
        runs-on: ubuntu-latest

        services:
            mysql:
                image: mysql:8.0
                ports:
                    - 3306:3306
                env:
                    MYSQL_DATABASE: ${{ secrets.DB_NAME }}
                    MYSQL_USER: ${{ secrets.DB_USER }}
                    MYSQL_PASSWORD: ${{ secrets.DB_PASSWORD }}
                    MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
                    options: >-
                        --health-cmd="mysqladmin ping -h 127.0.0.1"
                        --health-interval=10s
                        --health-timeout=5s
                        --health-retries=5
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Go
              uses: actions/setup-go@v5
              with:
                go-version: '1.25'

            - name: Cache Go modules
              uses: actions/cache@v4
              with:
                path: |
                    ~/go/pkg/mod
                    ~/.cache/go-build
                key: go-${{ runner.os }}-${{ hashFiles('**/go.sum') }}

            - name: Wait for MySQL
              run: |
                for i in {1..20}; do
                    mysqladmin ping -h 127.0.0.1 -u${{ secrets.DB_USER }} -p${{ secrets.DB_PASSWORD }} && break
                    sleep 3
                done

            - name: Run migrations
              env:
                DB_DSN: "${{ secrets.DB_USER }}:${{ secrets.DB_PASSWORD }}@tcp(127.0.0.1:3306)/${{ secrets.DB_NAME }}?parseTime=true"
              run: |
                mysql -h 127.0.0.1 -u${{ secrets.DB_USER }} -p${{ secrets.DB_PASSWORD }} ${{ secrets.DB_NAME }} < ./migrations/schema.sql

            - name: Run integration tests
              env:
                DB_DSN: "${{ secrets.DB_USER }}:${{ secrets.DB_PASSWORD }}@tcp(127.0.0.1:3306)/${{ secrets.DB_NAME }}?parseTime=true"
              run: make test-integration    